<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Hello World - Towerhouse</title>
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#4F46E5">
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f5f5;
      min-height: 100vh;
      padding: 1rem;
    }

    .container {
      max-width: 600px;
      margin: 0 auto;
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 2rem;
    }

    h1 {
      font-size: 1.5rem;
      color: #1a1a1a;
    }

    .back-link {
      color: #4F46E5;
      text-decoration: none;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .card {
      background: white;
      border-radius: 12px;
      padding: 1.5rem;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      margin-bottom: 1rem;
    }

    .card h2 {
      margin-bottom: 1rem;
      color: #1a1a1a;
    }

    button {
      background: #4F46E5;
      color: white;
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 8px;
      font-size: 1rem;
      cursor: pointer;
      width: 100%;
      margin-bottom: 0.5rem;
    }

    button:hover {
      background: #4338CA;
    }

    button:disabled {
      background: #9CA3AF;
      cursor: not-allowed;
    }

    button.secondary {
      background: #E5E7EB;
      color: #374151;
    }

    button.secondary:hover {
      background: #D1D5DB;
    }

    .result {
      margin-top: 1rem;
      padding: 1rem;
      background: #F3F4F6;
      border-radius: 8px;
      font-size: 1.1rem;
    }

    .result.success {
      background: #D1FAE5;
      color: #065F46;
    }

    select {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid #D1D5DB;
      border-radius: 8px;
      font-size: 1rem;
      margin-bottom: 1rem;
      background: white;
    }

    .stats {
      display: flex;
      gap: 1rem;
      margin-top: 1rem;
    }

    .stat {
      flex: 1;
      text-align: center;
      padding: 1rem;
      background: #EEF2FF;
      border-radius: 8px;
    }

    .stat-value {
      font-size: 2rem;
      font-weight: bold;
      color: #4F46E5;
    }

    .stat-label {
      font-size: 0.8rem;
      color: #6B7280;
    }

    .status-grid {
      display: grid;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }

    .status-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.75rem;
      background: #F9FAFB;
      border-radius: 8px;
      font-size: 0.9rem;
    }

    .status-label {
      color: #6B7280;
      font-weight: 500;
    }

    .status-value {
      font-weight: 600;
    }

    .status-value.success {
      color: #059669;
    }

    .status-value.error {
      color: #DC2626;
    }

    .status-value.warning {
      color: #D97706;
    }

    .button-group {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.5rem;
    }

    .button-group button {
      margin-bottom: 0;
    }

    button.danger {
      background: #DC2626;
    }

    button.danger:hover {
      background: #B91C1C;
    }

    button.success {
      background: #059669;
    }

    button.success:hover {
      background: #047857;
    }

    .info-box {
      padding: 0.75rem;
      background: #EFF6FF;
      border-left: 3px solid #3B82F6;
      border-radius: 4px;
      font-size: 0.85rem;
      color: #1E40AF;
      margin-top: 1rem;
    }

    code {
      background: #F3F4F6;
      padding: 0.2rem 0.4rem;
      border-radius: 4px;
      font-family: 'Courier New', monospace;
      font-size: 0.85rem;
    }

    .debug-log {
      margin-top: 1rem;
      border: 1px solid #D1D5DB;
      border-radius: 8px;
      background: #1F2937;
      max-height: 300px;
      overflow-y: auto;
    }

    .debug-log-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.5rem 0.75rem;
      background: #374151;
      border-bottom: 1px solid #4B5563;
      border-radius: 8px 8px 0 0;
      position: sticky;
      top: 0;
      z-index: 1;
    }

    .debug-log-title {
      color: #F9FAFB;
      font-weight: 600;
      font-size: 0.85rem;
    }

    .debug-log-clear {
      background: #DC2626;
      color: white;
      border: none;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      font-size: 0.75rem;
      cursor: pointer;
    }

    .debug-log-clear:hover {
      background: #B91C1C;
    }

    .debug-log-content {
      padding: 0.5rem;
      font-family: 'Courier New', monospace;
      font-size: 0.75rem;
      color: #E5E7EB;
    }

    .log-entry {
      padding: 0.25rem 0.5rem;
      margin-bottom: 0.25rem;
      border-radius: 4px;
      word-wrap: break-word;
    }

    .log-entry.info {
      background: #1E3A8A;
      color: #BFDBFE;
    }

    .log-entry.success {
      background: #065F46;
      color: #A7F3D0;
    }

    .log-entry.error {
      background: #7F1D1D;
      color: #FCA5A5;
    }

    .log-entry.warning {
      background: #78350F;
      color: #FCD34D;
    }

    .log-timestamp {
      opacity: 0.6;
      font-size: 0.7rem;
      margin-right: 0.5rem;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>üëã Hello World</h1>
      <a href="/" class="back-link">‚Üê Back</a>
    </header>

    <div class="card">
      <h2>Simple Greeting</h2>
      <button id="greet-btn">Get Greeting</button>
      <div id="greet-result" class="result" style="display: none;"></div>
    </div>

    <div class="card">
      <h2>AI-Powered Greeting</h2>
      <p style="margin-bottom: 1rem; color: #666;">Get a personalized greeting from Claude!</p>

      <select id="mood-select">
        <option value="">How are you feeling?</option>
        <option value="happy">Happy üòä</option>
        <option value="tired">Tired üò¥</option>
        <option value="excited">Excited üéâ</option>
        <option value="curious">Curious ü§î</option>
        <option value="stressed">Stressed üò∞</option>
      </select>

      <button id="ai-greet-btn">Get AI Greeting</button>
      <div id="ai-result" class="result" style="display: none;"></div>
    </div>

    <div class="card">
      <h2>Visit Counter</h2>
      <p style="margin-bottom: 1rem; color: #666;">Track how many times you've visited.</p>
      <button id="visit-btn">Record Visit</button>

      <div class="stats">
        <div class="stat">
          <div class="stat-value" id="visit-count">-</div>
          <div class="stat-label">Total Visits</div>
        </div>
      </div>
    </div>

    <div class="card">
      <h2>üîî Notification Debugger</h2>
      <p style="margin-bottom: 1rem; color: #666;">Debug and test PWA push notifications.</p>

      <div class="status-grid">
        <div class="status-item">
          <span class="status-label">Browser Support</span>
          <span class="status-value" id="browser-support">-</span>
        </div>
        <div class="status-item">
          <span class="status-label">Permission Status</span>
          <span class="status-value" id="permission-status">-</span>
        </div>
        <div class="status-item">
          <span class="status-label">Service Worker</span>
          <span class="status-value" id="sw-status">-</span>
        </div>
        <div class="status-item">
          <span class="status-label">Push Subscription</span>
          <span class="status-value" id="subscription-status">-</span>
        </div>
      </div>

      <div class="button-group">
        <button id="request-permission-btn">Request Permission</button>
        <button id="subscribe-btn" class="success">Subscribe to Push</button>
      </div>

      <div class="button-group" style="margin-top: 0.5rem;">
        <button id="test-local-btn" class="secondary">Test Local Notification</button>
        <button id="test-push-btn" class="secondary">Test Push Notification</button>
      </div>

      <button id="unsubscribe-btn" class="danger" style="margin-top: 0.5rem;">Unsubscribe</button>

      <button id="refresh-status-btn" class="secondary" style="margin-top: 0.5rem;">Refresh Status</button>

      <div id="notification-result" class="result" style="display: none;"></div>

      <div class="info-box">
        <strong>How to use:</strong><br>
        1. Check if browser supports notifications<br>
        2. Request permission if needed<br>
        3. Subscribe to push notifications<br>
        4. Test local and push notifications<br>
        5. Check debug log below for detailed information
      </div>

      <div class="debug-log">
        <div class="debug-log-header">
          <span class="debug-log-title">üìã Debug Log</span>
          <button class="debug-log-clear" id="clear-log-btn">Clear</button>
        </div>
        <div class="debug-log-content" id="debug-log-content">
          <div class="log-entry info">Debug log initialized. Actions will appear here.</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = '/hello/api';

    // Simple greeting
    document.getElementById('greet-btn').addEventListener('click', async () => {
      const btn = document.getElementById('greet-btn');
      const result = document.getElementById('greet-result');

      btn.disabled = true;
      btn.textContent = 'Loading...';

      try {
        const response = await fetch(`${API_BASE}/greet`);
        const data = await response.json();

        result.style.display = 'block';
        result.className = 'result success';
        result.textContent = data.message;
      } catch (error) {
        result.style.display = 'block';
        result.className = 'result';
        result.textContent = 'Error: ' + error.message;
      } finally {
        btn.disabled = false;
        btn.textContent = 'Get Greeting';
      }
    });

    // AI greeting
    document.getElementById('ai-greet-btn').addEventListener('click', async () => {
      const btn = document.getElementById('ai-greet-btn');
      const result = document.getElementById('ai-result');
      const mood = document.getElementById('mood-select').value;

      btn.disabled = true;
      btn.textContent = 'Thinking...';

      try {
        const response = await fetch(`${API_BASE}/greet-ai`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ mood })
        });
        const data = await response.json();

        result.style.display = 'block';
        result.className = 'result success';
        result.textContent = data.greeting;
      } catch (error) {
        result.style.display = 'block';
        result.className = 'result';
        result.textContent = 'Error: ' + error.message;
      } finally {
        btn.disabled = false;
        btn.textContent = 'Get AI Greeting';
      }
    });

    // Visit counter
    document.getElementById('visit-btn').addEventListener('click', async () => {
      const btn = document.getElementById('visit-btn');
      const countEl = document.getElementById('visit-count');

      btn.disabled = true;
      btn.textContent = 'Recording...';

      try {
        const response = await fetch(`${API_BASE}/visits`);
        const data = await response.json();

        countEl.textContent = data.visits;
      } catch (error) {
        console.error('Error recording visit:', error);
      } finally {
        btn.disabled = false;
        btn.textContent = 'Record Visit';
      }
    });

    // ============================================
    // Notification Debugging
    // ============================================

    // Debug log viewer
    function addDebugLog(message, type = 'info') {
      const logContent = document.getElementById('debug-log-content');
      const timestamp = new Date().toLocaleTimeString();

      const logEntry = document.createElement('div');
      logEntry.className = `log-entry ${type}`;
      logEntry.innerHTML = `<span class="log-timestamp">${timestamp}</span>${message}`;

      logContent.appendChild(logEntry);

      // Auto-scroll to bottom
      logContent.parentElement.scrollTop = logContent.parentElement.scrollHeight;

      // Also log to console for debugging
      const consoleMethod = type === 'error' ? console.error : console.log;
      consoleMethod(`[${timestamp}] ${message}`);
    }

    // Clear log button
    document.getElementById('clear-log-btn').addEventListener('click', () => {
      const logContent = document.getElementById('debug-log-content');
      logContent.innerHTML = '<div class="log-entry info">Debug log cleared.</div>';
    });

    function urlBase64ToUint8Array(base64String) {
      const padding = '='.repeat((4 - base64String.length % 4) % 4);
      const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
      const rawData = window.atob(base64);
      const outputArray = new Uint8Array(rawData.length);
      for (let i = 0; i < rawData.length; ++i) {
        outputArray[i] = rawData.charCodeAt(i);
      }
      return outputArray;
    }

    function showNotificationResult(message, isSuccess = true) {
      const result = document.getElementById('notification-result');
      result.style.display = 'block';
      result.className = isSuccess ? 'result success' : 'result';
      result.textContent = message;
      setTimeout(() => {
        result.style.display = 'none';
      }, 5000);
    }

    async function checkNotificationStatus() {
      addDebugLog('üîç Checking notification status...', 'info');

      // Check browser support
      const browserSupport = document.getElementById('browser-support');
      if ('Notification' in window && 'serviceWorker' in navigator && 'PushManager' in window) {
        browserSupport.textContent = 'Supported';
        browserSupport.className = 'status-value success';
        addDebugLog('‚úÖ Browser supports notifications', 'success');
      } else {
        browserSupport.textContent = 'Not Supported';
        browserSupport.className = 'status-value error';
        addDebugLog('‚ùå Browser does not support notifications', 'error');
        return;
      }

      // Check permission status
      const permissionStatus = document.getElementById('permission-status');
      const permission = Notification.permission;
      permissionStatus.textContent = permission;
      permissionStatus.className = permission === 'granted' ? 'status-value success' :
                                     permission === 'denied' ? 'status-value error' :
                                     'status-value warning';

      if (permission === 'granted') {
        addDebugLog('‚úÖ Permission: granted', 'success');
      } else if (permission === 'denied') {
        addDebugLog('‚ùå Permission: denied', 'error');
      } else {
        addDebugLog('‚ö†Ô∏è Permission: not requested yet', 'warning');
      }

      // Check service worker status
      const swStatus = document.getElementById('sw-status');
      try {
        const registration = await navigator.serviceWorker.getRegistration();
        if (registration) {
          swStatus.textContent = registration.active ? 'Active' : 'Installing';
          swStatus.className = registration.active ? 'status-value success' : 'status-value warning';
          if (registration.active) {
            addDebugLog('‚úÖ Service Worker is active', 'success');
          } else {
            addDebugLog('‚ö†Ô∏è Service Worker is installing...', 'warning');
          }
        } else {
          swStatus.textContent = 'Not Registered';
          swStatus.className = 'status-value error';
          addDebugLog('‚ùå Service Worker not registered', 'error');
        }
      } catch (error) {
        addDebugLog(`‚ùå Service Worker check failed: ${error.message}`, 'error');
        swStatus.textContent = 'Error';
        swStatus.className = 'status-value error';
      }

      // Check push subscription status
      const subscriptionStatus = document.getElementById('subscription-status');
      try {
        const response = await fetch(`${API_BASE}/notifications/status`);
        const data = await response.json();

        if (data.hasSubscription) {
          subscriptionStatus.textContent = 'Subscribed';
          subscriptionStatus.className = 'status-value success';
          addDebugLog('‚úÖ Push subscription active', 'success');
          addDebugLog(`Endpoint: ${data.subscription.endpoint.substring(0, 50)}...`, 'info');
        } else {
          subscriptionStatus.textContent = 'Not Subscribed';
          subscriptionStatus.className = 'status-value warning';
          addDebugLog('‚ö†Ô∏è No push subscription found', 'warning');
        }
      } catch (error) {
        addDebugLog(`‚ùå Failed to check subscription: ${error.message}`, 'error');
        subscriptionStatus.textContent = 'Error';
        subscriptionStatus.className = 'status-value error';
      }
    }

    // Request permission
    document.getElementById('request-permission-btn').addEventListener('click', async () => {
      addDebugLog('üì¢ Requesting notification permission...', 'info');
      try {
        const permission = await Notification.requestPermission();
        addDebugLog(`Permission result: ${permission}`, permission === 'granted' ? 'success' : 'warning');
        showNotificationResult(`Permission ${permission}`, permission === 'granted');
        await checkNotificationStatus();
      } catch (error) {
        addDebugLog(`‚ùå Permission request failed: ${error.message}`, 'error');
        showNotificationResult('Failed to request permission: ' + error.message, false);
      }
    });

    // Subscribe to push notifications
    document.getElementById('subscribe-btn').addEventListener('click', async () => {
      const btn = document.getElementById('subscribe-btn');
      btn.disabled = true;
      btn.textContent = 'Subscribing...';

      try {
        addDebugLog('üîî Starting push subscription...', 'info');

        if (Notification.permission !== 'granted') {
          addDebugLog('‚ùå Permission not granted', 'error');
          showNotificationResult('Please grant notification permission first', false);
          return;
        }

        addDebugLog('‚è≥ Waiting for service worker...', 'info');
        const registration = await navigator.serviceWorker.ready;
        addDebugLog('‚úÖ Service worker ready', 'success');

        // Get VAPID public key
        addDebugLog('üîë Fetching VAPID public key...', 'info');
        const vapidResponse = await fetch('/api/push/vapid-key');
        const { publicKey } = await vapidResponse.json();
        addDebugLog(`‚úÖ Got VAPID key: ${publicKey.substring(0, 20)}...`, 'success');

        // Subscribe
        addDebugLog('üìù Creating push subscription...', 'info');
        const subscription = await registration.pushManager.subscribe({
          userVisibleOnly: true,
          applicationServerKey: urlBase64ToUint8Array(publicKey)
        });
        addDebugLog('‚úÖ Push subscription created', 'success');

        // Send to server
        addDebugLog('üíæ Saving subscription to server...', 'info');
        const response = await fetch(`${API_BASE}/notifications/subscribe`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(subscription)
        });

        const data = await response.json();
        addDebugLog('‚úÖ Subscription saved successfully!', 'success');

        showNotificationResult(data.message || 'Successfully subscribed!', true);
        await checkNotificationStatus();
      } catch (error) {
        addDebugLog(`‚ùå Subscription failed: ${error.message}`, 'error');
        showNotificationResult('Failed to subscribe: ' + error.message, false);
      } finally {
        btn.disabled = false;
        btn.textContent = 'Subscribe to Push';
      }
    });

    // Test local notification
    document.getElementById('test-local-btn').addEventListener('click', () => {
      addDebugLog('üîî Testing local notification...', 'info');
      if (Notification.permission !== 'granted') {
        addDebugLog('‚ùå Permission not granted', 'error');
        showNotificationResult('Please grant notification permission first', false);
        return;
      }

      const notification = new Notification('Local Test Notification', {
        body: 'This is a local notification test from the Hello app',
        icon: '/icons/icon-192.png',
        badge: '/icons/icon-192.png',
        tag: 'local-test'
      });

      notification.onclick = () => {
        addDebugLog('üëÜ Notification clicked', 'info');
        window.focus();
        notification.close();
      };

      addDebugLog('‚úÖ Local notification sent!', 'success');
      showNotificationResult('Local notification sent!', true);
    });

    // Test push notification
    document.getElementById('test-push-btn').addEventListener('click', async () => {
      const btn = document.getElementById('test-push-btn');
      btn.disabled = true;
      btn.textContent = 'Sending...';

      try {
        addDebugLog('üì§ Sending test push notification...', 'info');
        const response = await fetch(`${API_BASE}/notifications/test`, {
          method: 'POST'
        });

        const data = await response.json();

        if (data.success) {
          addDebugLog('‚úÖ Push notification sent successfully!', 'success');
          addDebugLog('Check your device for the notification', 'info');
        } else {
          addDebugLog(`‚ùå ${data.error || data.message}`, 'error');
        }

        showNotificationResult(data.message, data.success);
      } catch (error) {
        addDebugLog(`‚ùå Push test failed: ${error.message}`, 'error');
        showNotificationResult('Failed to send push notification: ' + error.message, false);
      } finally {
        btn.disabled = false;
        btn.textContent = 'Test Push Notification';
      }
    });

    // Unsubscribe
    document.getElementById('unsubscribe-btn').addEventListener('click', async () => {
      const btn = document.getElementById('unsubscribe-btn');
      btn.disabled = true;
      btn.textContent = 'Unsubscribing...';

      try {
        addDebugLog('üîï Unsubscribing from push notifications...', 'info');

        // Unsubscribe from push manager
        const registration = await navigator.serviceWorker.ready;
        const subscription = await registration.pushManager.getSubscription();
        if (subscription) {
          await subscription.unsubscribe();
          addDebugLog('‚úÖ Unsubscribed from push manager', 'success');
        } else {
          addDebugLog('‚ö†Ô∏è No active subscription found in browser', 'warning');
        }

        // Remove from server
        addDebugLog('üóëÔ∏è Removing subscription from server...', 'info');
        const response = await fetch(`${API_BASE}/notifications/subscribe`, {
          method: 'DELETE'
        });

        const data = await response.json();
        addDebugLog('‚úÖ Subscription removed from server', 'success');

        showNotificationResult(data.message || 'Successfully unsubscribed!', true);
        await checkNotificationStatus();
      } catch (error) {
        addDebugLog(`‚ùå Unsubscribe failed: ${error.message}`, 'error');
        showNotificationResult('Failed to unsubscribe: ' + error.message, false);
      } finally {
        btn.disabled = false;
        btn.textContent = 'Unsubscribe';
      }
    });

    // Refresh status
    document.getElementById('refresh-status-btn').addEventListener('click', async () => {
      addDebugLog('üîÑ Refreshing status...', 'info');
      await checkNotificationStatus();
      showNotificationResult('Status refreshed', true);
    });

    // Initialize notification status on page load
    checkNotificationStatus();
  </script>
</body>
</html>
